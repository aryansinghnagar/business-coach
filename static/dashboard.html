<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Dashboard — Business Meeting Copilot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Design tokens — 8px grid, consistent spacing, modern contrast */
        :root {
            --main-bg: #080b0f;
            --main-bg-mesh: radial-gradient(ellipse 120% 70% at 50% -20%, rgba(6, 182, 212, 0.08) 0%, transparent 50%),
                            radial-gradient(ellipse 80% 40% at 100% 50%, rgba(99, 102, 241, 0.04) 0%, transparent 45%);
            --surface: rgba(255, 255, 255, 0.05);
            --surface-raised: rgba(255, 255, 255, 0.07);
            --surface-border: rgba(255, 255, 255, 0.08);
            --surface-border-strong: rgba(255, 255, 255, 0.12);
            --accent: #06b6d4;
            --accent-hover: #22d3ee;
            --accent-subtle: rgba(6, 182, 212, 0.18);
            --accent-ring: rgba(6, 182, 212, 0.4);
            --success: #34d399;
            --success-subtle: rgba(52, 211, 153, 0.15);
            --warning: #fbbf24;
            --text: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-tertiary: #64748b;
            --radius: 16px;
            --radius-sm: 10px;
            --radius-pill: 9999px;
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --text-xs: 0.6875rem;
            --text-sm: 0.8125rem;
            --text-base: 0.9375rem;
            --text-lg: 1.0625rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --leading-tight: 1.25;
            --leading-normal: 1.5;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 24px rgba(0, 0, 0, 0.25);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.3);
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            --duration: 0.2s;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        @media (prefers-reduced-motion: reduce) { html { scroll-behavior: auto; } }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--main-bg);
            color: var(--text);
            min-height: 100vh;
            padding: var(--space-6);
            line-height: var(--leading-normal);
            -webkit-font-smoothing: antialiased;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: var(--main-bg-mesh);
            pointer-events: none;
            z-index: 0;
        }

        .dashboard-wrap {
            position: relative;
            z-index: 1;
            max-width: 1440px;
            margin: 0 auto;
        }

        /* Header — clear hierarchy, live indicator */
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-4);
            margin-bottom: var(--space-8);
        }
        .dashboard-header h1 {
            font-family: 'DM Sans', var(--font-sans);
            font-size: var(--text-2xl);
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text);
            line-height: var(--leading-tight);
        }
        .dashboard-header h1 .accent { color: var(--accent); }
        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-pill);
            background: var(--success-subtle);
            border: 1px solid rgba(52, 211, 153, 0.3);
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--success);
            letter-spacing: 0.02em;
        }
        .live-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: live-pulse 2s ease-in-out infinite;
        }
        @keyframes live-pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.95); } }
        @media (prefers-reduced-motion: reduce) { .live-badge::before { animation: none; } }

        /* Grid — responsive, consistent gaps */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 360px), 1fr));
            gap: var(--space-5);
        }
        @media (min-width: 900px) {
            .dashboard-grid { gap: var(--space-6); }
        }

        /* Cards — elevation, hover, focus */
        .card {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            border-radius: var(--radius);
            padding: var(--space-5);
            overflow: hidden;
            transition: border-color var(--duration) ease, box-shadow var(--duration) var(--ease-out);
        }
        .card:hover {
            border-color: var(--surface-border-strong);
            box-shadow: var(--shadow-md);
        }
        .card:focus-within { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
        .card.wide {
            grid-column: 1 / -1;
            padding: var(--space-6);
            background: var(--surface-raised);
        }
        .card.wide:hover { box-shadow: var(--shadow-md); }

        .card-title {
            font-family: 'DM Sans', sans-serif;
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--surface-border);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            letter-spacing: -0.01em;
        }
        .card-title::before {
            content: '';
            width: 4px;
            height: 1.1em;
            border-radius: 2px;
            background: var(--accent);
        }

        .card-body {
            font-size: var(--text-sm);
            color: var(--text);
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: var(--leading-normal);
        }
        .card-body::-webkit-scrollbar { width: 6px; }
        .card-body::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 3px; }
        .card-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 3px; }
        .card-body.tall { max-height: 300px; }
        .card-body.metrics-scroll { max-height: 420px; overflow-y: auto; }
        .card-body.empty {
            color: var(--text-tertiary);
            font-style: italic;
        }

        /* Engagement summary bar — pill-style for scanability */
        .metrics-summary-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-5);
            padding: var(--space-3) 0;
        }
        .metrics-summary-bar .metrics-summary-inner {
            max-height: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            color: var(--text-muted);
        }
        .summary-pill {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-3);
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--surface-border);
            border-radius: var(--radius-pill);
            font-size: var(--text-xs);
            color: var(--text-muted);
        }

        /* Metric rows — alignment, hover */
        .metric-row {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
            padding: var(--space-1) 0;
            border-radius: var(--radius-sm);
            transition: background var(--duration) ease;
        }
        .metric-row:hover { background: rgba(255,255,255,0.03); }
        .metric-label {
            color: var(--text-muted);
            flex: 0 0 140px;
            font-size: var(--text-xs);
        }
        .metric-value {
            font-weight: 600;
            min-width: 2.5em;
            text-align: right;
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
        }
        .metric-bar-wrap {
            flex: 1;
            min-width: 64px;
            height: 8px;
            background: rgba(0,0,0,0.35);
            border-radius: var(--radius-pill);
            overflow: hidden;
        }
        .metric-bar-fill {
            height: 100%;
            width: 0%;
            border-radius: var(--radius-pill);
            transition: width 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.25s ease;
        }
        .signifier-bar-fill {
            transition: width 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.25s ease;
        }

        .hint { font-size: var(--text-xs); color: var(--text-tertiary); margin-top: var(--space-2); }
        .timestamp {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            margin-top: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .timestamp.updated { color: var(--success); }
        .timestamp.updated::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: currentColor;
        }

        .engagement-live-strip {
            margin-bottom: var(--space-4);
            padding: var(--space-4);
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-sm);
            border: 1px solid var(--surface-border);
        }
        .engagement-live-main {
            display: flex;
            align-items: baseline;
            gap: var(--space-3);
            flex-wrap: wrap;
        }
        .engagement-score-wrap {
            display: flex;
            align-items: baseline;
            gap: 2px;
        }
        .engagement-live-score {
            font-size: 2rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--text);
            transition: color 0.3s ease;
        }
        .engagement-live-max { font-size: var(--text-base); color: var(--text-muted); }
        .engagement-live-level {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s ease;
        }
        .engagement-live-bar-wrap {
            margin-top: var(--space-2);
            height: 6px;
            background: rgba(0,0,0,0.35);
            border-radius: var(--radius-pill);
            overflow: hidden;
        }
        .engagement-live-bar-fill {
            height: 100%;
            border-radius: var(--radius-pill);
            background: var(--accent);
            transition: width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.3s ease;
        }
        @media (prefers-reduced-motion: reduce) {
            .metric-bar-fill, .signifier-bar-fill, .engagement-live-bar-fill, .engagement-live-score, .engagement-live-level { transition: none; }
        }
        .metrics-section { margin-bottom: var(--space-6); }
        .metrics-section:last-child { margin-bottom: 0; }
        .metrics-section-title {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--accent);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--surface-border);
        }

        .signifier-list { display: flex; flex-direction: column; gap: var(--space-2); }
        .signifier-row {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--text-xs);
            padding: var(--space-1) 0;
            border-radius: var(--radius-sm);
            transition: background var(--duration) ease;
        }
        .signifier-row:hover { background: rgba(255,255,255,0.02); }
        .signifier-label {
            flex: 0 0 130px;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .signifier-bar {
            flex: 1;
            min-width: 48px;
            height: 6px;
            background: rgba(0,0,0,0.35);
            border-radius: var(--radius-pill);
            overflow: hidden;
        }
        .signifier-bar-fill {
            height: 100%;
            width: 0%;
            border-radius: var(--radius-pill);
        }
        .signifier-value {
            flex: 0 0 3em;
            text-align: right;
            font-weight: 600;
            font-size: var(--text-xs);
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
        }

        /* Additional context card — form UX */
        .dashboard-additional-desc {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-bottom: var(--space-3);
            line-height: var(--leading-normal);
        }
        .dashboard-additional-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid var(--surface-border);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            font-size: var(--text-sm);
            font-family: inherit;
            line-height: var(--leading-normal);
            resize: vertical;
            min-height: 88px;
            margin-bottom: var(--space-4);
            transition: border-color var(--duration) ease, box-shadow var(--duration) ease;
        }
        .dashboard-additional-input:hover { border-color: var(--surface-border-strong); }
        .dashboard-additional-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-subtle);
        }
        .dashboard-additional-input::placeholder { color: var(--text-tertiary); }

        .dashboard-pass-row {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
        }
        .dashboard-pass-btn {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background var(--duration) ease, border-color var(--duration) ease, transform var(--duration) ease, box-shadow var(--duration) ease;
        }
        .dashboard-pass-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-ring);
        }
        .dashboard-pass-btn:active:not(:disabled) { transform: scale(0.98); }
        .dashboard-pass-btn.append {
            border: 1px solid var(--surface-border);
            background: var(--surface);
            color: var(--text-secondary);
        }
        .dashboard-pass-btn.append:hover:not(:disabled) {
            background: var(--surface-raised);
            border-color: var(--surface-border-strong);
            color: var(--text);
        }
        .dashboard-pass-btn.send-now {
            border: 1px solid var(--accent);
            background: var(--accent-subtle);
            color: var(--accent);
        }
        .dashboard-pass-btn.send-now:hover:not(:disabled) {
            background: rgba(6, 182, 212, 0.25);
            border-color: var(--accent);
            color: var(--accent-hover);
        }
        .dashboard-pass-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .dashboard-pass-status {
            font-size: var(--text-xs);
            color: var(--text-muted);
            min-height: 1.25em;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }
        .dashboard-pass-status.success { color: var(--success); }
        .dashboard-pass-status.success::before { content: '✓'; font-weight: 700; }
        .dashboard-pass-status.error { color: #f87171; }

        /* Responsive */
        @media (max-width: 640px) {
            body { padding: var(--space-4); }
            .dashboard-header { margin-bottom: var(--space-5); }
            .dashboard-header h1 { font-size: var(--text-xl); }
            .card { padding: var(--space-4); }
            .card.wide { padding: var(--space-5); }
            .metric-label { flex: 0 0 110px; font-size: 0.7rem; }
            .signifier-label { flex: 0 0 100px; }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrap">
    <header class="dashboard-header">
        <h1><span class="accent">Meeting</span> Dashboard</h1>
        <span class="live-badge" aria-hidden="true">Live</span>
    </header>
    <div class="dashboard-grid">
        <!-- Engagement metrics: lightweight, smooth real-time updates (expression, speech, acoustics) -->
        <div class="card wide" id="engagementCard">
            <div class="card-title">Engagement</div>
            <div id="engagementLiveStrip" class="engagement-live-strip" aria-live="polite">
                <div class="engagement-live-main">
                    <div class="engagement-score-wrap">
                        <span id="engagementLiveScore" class="engagement-live-score">—</span>
                        <span class="engagement-live-max">/100</span>
                    </div>
                    <span id="engagementLiveLevel" class="engagement-live-level">—</span>
                </div>
                <div class="engagement-live-bar-wrap">
                    <div id="engagementLiveBar" class="engagement-live-bar-fill" style="width:0%"></div>
                </div>
            </div>
            <div class="metrics-summary-bar">
                <div id="engagementMetricsSummary" class="card-body metrics-summary-inner" aria-live="polite"></div>
            </div>
            <div id="engagementMetricsBasic" class="metrics-section"></div>
            <div id="engagementMetricsSignifiers" class="metrics-section card-body metrics-scroll" style="max-height: 380px;"></div>
            <div id="engagementMetricsComposite" class="metrics-section"></div>
            <div id="engagementMetricsAzure" class="metrics-section"></div>
        </div>
        <div class="card">
            <div class="card-title">Additional context</div>
            <p class="dashboard-additional-desc">Add meeting details, goals, or notes. Click <strong>Append to next context</strong> to save this text; it will be included the next time context is sent to Azure AI Foundry (e.g. when you send a chat message or when the app sends a periodic update). Use <strong>Send to Foundry now</strong> to run a context push immediately with any saved text.</p>
            <textarea id="dashboardAdditionalContext" class="dashboard-additional-input" rows="3" placeholder="e.g. Topic: Q4 pipeline review. Goal: get commitment on timeline. Key concern: budget."></textarea>
            <div class="dashboard-pass-row">
                <button type="button" id="dashboardAppendContextBtn" class="dashboard-pass-btn append">Append to next context</button>
                <button type="button" id="dashboardSendNowBtn" class="dashboard-pass-btn send-now">Send to Foundry now</button>
                <span id="dashboardPassStatus" class="dashboard-pass-status" aria-live="polite"></span>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Context summary</div>
            <div id="contextSummary" class="card-body">—</div>
        </div>
        <div class="card">
            <div class="card-title">Context passed to Azure AI Foundry</div>
            <div id="contextSent" class="card-body tall empty">No context sent yet. Use "Send to Foundry now" or send a chat message.</div>
            <div id="contextTimestamp" class="timestamp"></div>
        </div>
        <div class="card">
            <div class="card-title">Responses from Azure AI Foundry</div>
            <div id="lastResponse" class="card-body tall empty">No response yet. Trigger a context push or send a chat message.</div>
            <div id="responseTimestamp" class="timestamp"></div>
        </div>
    </div>
    </div>
    <script>
        function getApiBase() {
            if (typeof window !== 'undefined' && window.location && window.location.origin) {
                var o = window.location.origin;
                if (o && (o.indexOf('http://') === 0 || o.indexOf('https://') === 0)) return o;
            }
            return 'http://localhost:5000';
        }
        function barColor(score) {
            if (score >= 70) return '#22c55e';
            if (score >= 40) return '#eab308';
            return '#64748b';
        }
        var SIGNIFIER_LABELS = {
            g1_duchenne: 'Duchenne Marker', g1_pupil_dilation: 'Pupil Dilation', g1_eyebrow_flash: 'Eyebrow Flash',
            g1_eye_contact: 'Sustained Eye Contact', g1_head_tilt: 'Head Tilt (Lateral)', g1_forward_lean: 'Forward Lean',
            g1_facial_symmetry: 'Facial Symmetry', g1_rhythmic_nodding: 'Rhythmic Nodding', g1_parted_lips: 'Parted Lips', g1_softened_forehead: 'Softened Forehead',
            g1_micro_smile: 'Micro Smile', g1_brow_raise_sustained: 'Brow Raise Sustained', g1_mouth_open_receptive: 'Mouth Open Receptive', g1_eye_widening: 'Eye Widening', g1_nod_intensity: 'Nod Intensity',
            g2_look_up_lr: 'Look Up L/R', g2_lip_pucker: 'Lip Pucker', g2_eye_squint: 'Eye Squinting', g2_thinking_brow: 'Thinking Brow',
            g2_chin_stroke: 'Chin Stroke', g2_stillness: 'Stillness', g2_lowered_brow: 'Lowered Brow',
            g2_brow_furrow_deep: 'Brow Furrow Deep', g2_gaze_shift_frequency: 'Gaze Shift Frequency', g2_mouth_tight_eval: 'Mouth Tight (Eval)',
            g3_contempt: 'Contempt', g3_nose_crinkle: 'Nose Crinkle', g3_lip_compression: 'Lip Compression', g3_eye_block: 'Eye Block',
            g3_jaw_clench: 'Jaw Clenching', g3_rapid_blink: 'Rapid Blinking', g3_gaze_aversion: 'Gaze Aversion', g3_no_nod: 'No-Nod',
            g3_narrowed_pupils: 'Narrowed Pupils', g3_mouth_cover: 'Mouth Cover',
            g3_lip_corner_dip: 'Lip Corner Dip', g3_brow_lower_sustained: 'Brow Lower Sustained', g3_eye_squeeze: 'Eye Squeeze', g3_head_shake: 'Head Shake',
            g4_relaxed_exhale: 'Relaxed Exhale', g4_fixed_gaze: 'Fixed Gaze', g4_smile_transition: 'Smile to Genuine', g4_mouth_relax: 'Mouth Relax', g4_smile_sustain: 'Smile Sustain'
        };
        var SIGNIFIER_GROUPS = [
            { id: 'g1', title: 'Interest & Engagement', keys: ['g1_duchenne','g1_pupil_dilation','g1_eyebrow_flash','g1_eye_contact','g1_head_tilt','g1_forward_lean','g1_facial_symmetry','g1_rhythmic_nodding','g1_parted_lips','g1_softened_forehead','g1_micro_smile','g1_brow_raise_sustained','g1_mouth_open_receptive','g1_eye_widening','g1_nod_intensity'] },
            { id: 'g2', title: 'Cognitive Load', keys: ['g2_look_up_lr','g2_lip_pucker','g2_eye_squint','g2_thinking_brow','g2_chin_stroke','g2_stillness','g2_lowered_brow','g2_brow_furrow_deep','g2_gaze_shift_frequency','g2_mouth_tight_eval'] },
            { id: 'g3', title: 'Resistance & Objections', keys: ['g3_contempt','g3_nose_crinkle','g3_lip_compression','g3_eye_block','g3_jaw_clench','g3_rapid_blink','g3_gaze_aversion','g3_no_nod','g3_narrowed_pupils','g3_mouth_cover','g3_lip_corner_dip','g3_brow_lower_sustained','g3_eye_squeeze','g3_head_shake'] },
            { id: 'g4', title: 'Decision-Ready', keys: ['g4_relaxed_exhale','g4_fixed_gaze','g4_smile_transition','g4_mouth_relax','g4_smile_sustain'] }
        ];
        var COMPOSITE_LABELS = {
            verbal_nonverbal_alignment: 'Verbal–nonverbal alignment', cognitive_load_multimodal: 'Cognitive load (multimodal)',
            rapport_engagement: 'Rapport / engagement', skepticism_objection_strength: 'Skepticism / objection strength',
            decision_readiness_multimodal: 'Decision readiness (multimodal)', opportunity_strength: 'Opportunity strength',
            trust_rapport: 'Trust / rapport', disengagement_risk_multimodal: 'Disengagement risk (multimodal)',
            confusion_multimodal: 'Confusion (multimodal)', tension_objection_multimodal: 'Tension / objection (multimodal)',
            loss_of_interest_multimodal: 'Loss of interest (multimodal)', decision_plus_voice: 'Decision readiness + voice',
            psychological_safety_proxy: 'Psychological safety proxy', urgency_sensitivity: 'Urgency sensitivity',
            skepticism_strength: 'Skepticism strength', enthusiasm_multimodal: 'Enthusiasm (multimodal)',
            hesitation_multimodal: 'Hesitation (multimodal)', authority_deferral: 'Authority deferral',
            rapport_depth: 'Rapport depth', cognitive_overload_proxy: 'Cognitive overload proxy'
        };
        var COMPOSITE_KEYS = ['verbal_nonverbal_alignment','cognitive_load_multimodal','rapport_engagement','skepticism_objection_strength','decision_readiness_multimodal','opportunity_strength','trust_rapport','disengagement_risk_multimodal','confusion_multimodal','tension_objection_multimodal','loss_of_interest_multimodal','decision_plus_voice','psychological_safety_proxy','urgency_sensitivity','skepticism_strength','enthusiasm_multimodal','hesitation_multimodal','authority_deferral','rapport_depth','cognitive_overload_proxy'];
        var AZURE_BASE_LABELS = { anger: 'Anger', contempt: 'Contempt', disgust: 'Disgust', fear: 'Fear', happiness: 'Happiness', neutral: 'Neutral', sadness: 'Sadness', surprise: 'Surprise' };
        var AZURE_COMPOSITE_LABELS = { receptive: 'Receptive', focused: 'Focused', interested: 'Interested', agreeable: 'Agreeable', open: 'Open', skeptical: 'Skeptical', concerned: 'Concerned', disagreeing: 'Disagreeing', stressed: 'Stressed', disengaged: 'Disengaged' };

        function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        function setBarAndValue(el, pct, text, color) {
            if (!el) return;
            var fill = el.querySelector && (el.querySelector('.metric-bar-fill') || el.querySelector('.signifier-bar-fill'));
            var val = el.querySelector && (el.querySelector('.metric-value') || el.querySelector('.signifier-value'));
            if (fill) { fill.style.width = (typeof pct === 'number' ? Math.max(0, Math.min(100, pct)) : 0) + '%'; if (color) fill.style.background = color; }
            if (val) val.textContent = text;
        }
        var engagementDOMBuilt = false;
        var BASIC_KEYS = ['attention','eyeContact','facialExpressiveness','headMovement','symmetry','mouthActivity'];
        var BASIC_LABELS = { attention: 'Attention', eyeContact: 'Eye contact', facialExpressiveness: 'Facial expressiveness', headMovement: 'Head movement', symmetry: 'Symmetry', mouthActivity: 'Mouth activity' };
        function buildEngagementDOMOnce() {
            if (engagementDOMBuilt) return;
            var basicEl = document.getElementById('engagementMetricsBasic');
            var sigEl = document.getElementById('engagementMetricsSignifiers');
            var compEl = document.getElementById('engagementMetricsComposite');
            if (basicEl) {
                var basicParts = ['<div class="metrics-section-title">Basic metrics (0–100)</div>'];
                for (var i = 0; i < BASIC_KEYS.length; i++) {
                    var k = BASIC_KEYS[i];
                    basicParts.push('<div class="metric-row" data-metric="' + k + '"><span class="metric-label">' + escapeHtml(BASIC_LABELS[k]) + '</span><div class="metric-bar-wrap"><div class="metric-bar-fill" style="width:0%;background:#64748b"></div></div><span class="metric-value">—</span></div>');
                }
                basicEl.innerHTML = basicParts.join('');
            }
            if (sigEl) {
                var sigParts = [];
                for (var g = 0; g < SIGNIFIER_GROUPS.length; g++) {
                    var gr = SIGNIFIER_GROUPS[g];
                    sigParts.push('<div class="metrics-section-title">' + escapeHtml(gr.title) + '</div><div class="signifier-list">');
                    for (var j = 0; j < gr.keys.length; j++) {
                        var key = gr.keys[j];
                        sigParts.push('<div class="signifier-row" data-signifier="' + key + '"><span class="signifier-label">' + escapeHtml(SIGNIFIER_LABELS[key] || key) + '</span><div class="signifier-bar"><div class="signifier-bar-fill" style="width:0%;background:#64748b"></div></div><span class="signifier-value">—</span></div>');
                    }
                    sigParts.push('</div>');
                }
                sigEl.innerHTML = sigParts.length ? sigParts.join('') : '<div class="hint">No signifier data.</div>';
            }
            if (compEl) {
                var compParts = ['<div class="metrics-section-title">Composite (facial + speech + acoustics)</div><div class="signifier-list">'];
                for (var c = 0; c < COMPOSITE_KEYS.length; c++) {
                    var key = COMPOSITE_KEYS[c];
                    compParts.push('<div class="signifier-row" data-composite="' + key + '"><span class="signifier-label">' + escapeHtml(COMPOSITE_LABELS[key] || key) + '</span><div class="signifier-bar"><div class="signifier-bar-fill" style="width:0%;background:#64748b"></div></div><span class="signifier-value">—</span></div>');
                }
                compParts.push('</div>');
                compEl.innerHTML = compParts.join('');
            }
            engagementDOMBuilt = true;
        }
        function updateEngagementState(data) {
            var score = data.score != null ? Number(data.score) : NaN;
            var scorePct = (isNaN(score) || !isFinite(score)) ? 0 : Math.max(0, Math.min(100, score));
            var liveScoreEl = document.getElementById('engagementLiveScore');
            var liveLevelEl = document.getElementById('engagementLiveLevel');
            var liveBarEl = document.getElementById('engagementLiveBar');
            if (liveScoreEl) liveScoreEl.textContent = isNaN(score) || !isFinite(score) ? '—' : Math.round(score);
            if (liveLevelEl) liveLevelEl.textContent = data.level || '—';
            if (liveBarEl) {
                liveBarEl.style.width = scorePct + '%';
                liveBarEl.style.background = scorePct >= 70 ? '#22c55e' : scorePct >= 40 ? '#eab308' : '#64748b';
            }
            var summaryEl = document.getElementById('engagementMetricsSummary');
            if (summaryEl) {
                var parts = [
                    'Face: ' + (data.faceDetected ? 'Yes' : 'No'),
                    (data.detectionMethod ? data.detectionMethod : ''),
                    (data.fps != null ? 'FPS: ' + data.fps.toFixed(1) : '')
                ].filter(Boolean);
                summaryEl.innerHTML = parts.length ? parts.map(function (p) { return '<span class="summary-pill">' + escapeHtml(p) + '</span>'; }).join('') : '';
            }
            buildEngagementDOMOnce();
            var m = data.metrics || {};
            for (var i = 0; i < BASIC_KEYS.length; i++) {
                var k = BASIC_KEYS[i];
                var v = m[k];
                var num = v != null ? Number(v) : NaN;
                var pct = (!isNaN(num) && isFinite(num)) ? Math.max(0, Math.min(100, num)) : 0;
                var row = document.querySelector('[data-metric="' + k + '"]');
                setBarAndValue(row, pct, (!isNaN(num) && isFinite(num)) ? Math.round(num).toString() : '—', barColor(pct));
            }
            var sigScores = data.signifierScores || {};
            for (var g = 0; g < SIGNIFIER_GROUPS.length; g++) {
                for (var j = 0; j < SIGNIFIER_GROUPS[g].keys.length; j++) {
                    var key = SIGNIFIER_GROUPS[g].keys[j];
                    var v = sigScores[key];
                    var num = v != null ? Number(v) : NaN;
                    var pct = (!isNaN(num) && isFinite(num)) ? Math.max(0, Math.min(100, num)) : 0;
                    var row = document.querySelector('[data-signifier="' + key + '"]');
                    setBarAndValue(row, pct, (!isNaN(num) && isFinite(num)) ? Math.round(num).toString() : '—', barColor(pct));
                }
            }
            var comp = data.compositeMetrics || {};
            for (var c = 0; c < COMPOSITE_KEYS.length; c++) {
                var key = COMPOSITE_KEYS[c];
                var v = comp[key];
                var num = v != null ? Number(v) : NaN;
                var pct = (!isNaN(num) && isFinite(num)) ? Math.max(0, Math.min(100, num)) : 0;
                var row = document.querySelector('[data-composite="' + key + '"]');
                setBarAndValue(row, pct, (!isNaN(num) && isFinite(num)) ? Math.round(num).toString() : '—', barColor(pct));
            }
            var azureEl = document.getElementById('engagementMetricsAzure');
            var azure = data.azureMetrics;
            if (azureEl) {
                if (azure && (azure.base || azure.composite)) {
                    if (!document.querySelector('[data-azure-section]')) {
                        var azureHtml = '<div class="metrics-section-title" data-azure-section>Azure Face API</div>';
                        if (azure.score != null) azureHtml += '<div class="metric-row" data-azure="score"><span class="metric-label">Overall score</span><div class="metric-bar-wrap"><div class="metric-bar-fill" style="width:0%"></div></div><span class="metric-value">—</span></div>';
                        for (var bk in AZURE_BASE_LABELS) azureHtml += '<div class="metric-row" data-azure="base-' + bk + '"><span class="metric-label">' + escapeHtml(AZURE_BASE_LABELS[bk]) + '</span><div class="metric-bar-wrap"><div class="metric-bar-fill" style="width:0%"></div></div><span class="metric-value">—</span></div>';
                        azureHtml += '<div class="metrics-section-title" style="margin-top:12px">Azure B2B composites</div><div class="signifier-list">';
                        for (var ak in AZURE_COMPOSITE_LABELS) azureHtml += '<div class="signifier-row" data-azure="comp-' + ak + '"><span class="signifier-label">' + escapeHtml(AZURE_COMPOSITE_LABELS[ak]) + '</span><div class="signifier-bar"><div class="signifier-bar-fill" style="width:0%"></div></div><span class="signifier-value">—</span></div>';
                        azureHtml += '</div>';
                        azureEl.innerHTML = azureHtml;
                    }
                    var apct = azure.score != null ? Math.max(0, Math.min(100, azure.score)) : 0;
                    setBarAndValue(document.querySelector('[data-azure="score"]'), apct, azure.score != null ? Math.round(azure.score).toString() : '—', barColor(apct));
                    var baseObj = azure.base || {};
                    for (var bk in AZURE_BASE_LABELS) { var bv = baseObj[bk]; var bn = bv != null ? Number(bv) : NaN; var bp = (!isNaN(bn) && isFinite(bn)) ? Math.max(0, Math.min(100, bn)) : 0; setBarAndValue(document.querySelector('[data-azure="base-' + bk + '"]'), bp, (!isNaN(bn) && isFinite(bn)) ? Math.round(bn).toString() : '—', barColor(bp)); }
                    var compObj = azure.composite || {};
                    for (var ak in AZURE_COMPOSITE_LABELS) { var av = compObj[ak]; var anum = av != null ? Number(av) : NaN; var ap = (!isNaN(anum) && isFinite(anum)) ? Math.max(0, Math.min(100, anum)) : 0; setBarAndValue(document.querySelector('[data-azure="comp-' + ak + '"]'), ap, (!isNaN(anum) && isFinite(anum)) ? Math.round(anum).toString() : '—', barColor(ap)); }
                } else {
                    azureEl.innerHTML = '';
                }
            }
            var ctx = data.context || {};
            var ctxSummaryEl = document.getElementById('contextSummary');
            if (ctxSummaryEl) {
                var summaryText = (ctx.summary || '—').substring(0, 500) + (ctx.summary && ctx.summary.length > 500 ? '…' : '');
                ctxSummaryEl.textContent = summaryText;
                ctxSummaryEl.classList.toggle('empty', !ctx.summary || ctx.summary === '—');
            }
        }
        function pollEngagement() {
            var base = getApiBase();
            fetch(base + '/engagement/state?t=' + Date.now(), { method: 'GET', cache: 'no-cache' })
                .then(function (r) { return r.ok ? r.json() : null; })
                .then(function (data) { if (data) updateEngagementState(data); })
                .catch(function () {});
        }
        function pollContext() {
            var base = getApiBase();
            fetch(base + '/api/engagement/context-and-response?t=' + Date.now(), { method: 'GET' })
                .then(function (r) { return r.ok ? r.json() : null; })
                .then(function (data) {
                    if (!data) return;
                    var ctxEl = document.getElementById('contextSent');
                    var respEl = document.getElementById('lastResponse');
                    var tsCtx = document.getElementById('contextTimestamp');
                    var tsResp = document.getElementById('responseTimestamp');
                    if (ctxEl) { var ctxText = (data.contextSent && data.contextSent.length) ? data.contextSent : null; ctxEl.textContent = ctxText || 'No context sent yet.'; ctxEl.classList.toggle('empty', !ctxText); }
                    if (respEl) { var respText = (data.response && data.response.length) ? data.response : null; respEl.textContent = respText || 'No response yet.'; respEl.classList.toggle('empty', !respText); }
                    if (data.timestamp) { var t = new Date(data.timestamp * 1000).toLocaleTimeString(); if (tsCtx) { tsCtx.textContent = 'Updated ' + t; tsCtx.classList.add('updated'); } if (tsResp) { tsResp.textContent = 'Updated ' + t; tsResp.classList.add('updated'); } }
                })
                .catch(function () {});
        }
        pollEngagement();
        pollContext();
        setInterval(pollEngagement, 500);
        setInterval(pollContext, 2500);
        var appendBtn = document.getElementById('dashboardAppendContextBtn');
        var sendNowBtn = document.getElementById('dashboardSendNowBtn');
        var passStatus = document.getElementById('dashboardPassStatus');
        if (appendBtn) {
            appendBtn.addEventListener('click', function () {
                var input = document.getElementById('dashboardAdditionalContext');
                var text = (input && input.value) ? input.value.trim() : '';
                appendBtn.disabled = true;
                if (passStatus) passStatus.textContent = '';
                fetch(getApiBase() + '/api/engagement/set-additional-context', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ additionalContext: text || null })
                })
                    .then(function (r) {
                        if (!r.ok) return r.json().then(function (d) { throw new Error(d.error || d.details || 'Request failed'); }).catch(function () { throw new Error('Request failed'); });
                        return r.json();
                    })
                    .then(function () {
                        if (passStatus) {
                            passStatus.textContent = text ? 'Saved. Will be included in the next context sent to Foundry.' : 'Cleared.';
                            passStatus.className = 'dashboard-pass-status success';
                        }
                        setTimeout(function () { if (passStatus) { passStatus.textContent = ''; passStatus.className = 'dashboard-pass-status'; } }, 4000);
                    })
                    .catch(function (err) {
                        if (passStatus) { passStatus.textContent = err.message || 'Failed'; passStatus.className = 'dashboard-pass-status error'; }
                        setTimeout(function () { if (passStatus) passStatus.className = 'dashboard-pass-status'; }, 4000);
                    })
                    .finally(function () { appendBtn.disabled = false; });
            });
        }
        if (sendNowBtn) {
            sendNowBtn.addEventListener('click', function () {
                sendNowBtn.disabled = true;
                if (passStatus) passStatus.textContent = '';
                fetch(getApiBase() + '/api/context-push', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                    .then(function (r) {
                        if (!r.ok) return r.json().then(function (d) { throw new Error(d.error || d.details || 'Request failed'); }).catch(function () { throw new Error('Request failed'); });
                        return r.json();
                    })
                    .then(function (data) {
                        if (data.context != null) {
                            var ctxEl = document.getElementById('contextSent');
                            if (ctxEl) { ctxEl.textContent = data.context; ctxEl.classList.remove('empty'); }
                        }
                        if (data.response != null) {
                            var respEl = document.getElementById('lastResponse');
                            if (respEl) { respEl.textContent = data.response; respEl.classList.remove('empty'); }
                        }
                        var tsCtx = document.getElementById('contextTimestamp');
                        var tsResp = document.getElementById('responseTimestamp');
                        var t = new Date().toLocaleTimeString();
                        if (tsCtx) { tsCtx.textContent = 'Updated ' + t; tsCtx.classList.add('updated'); }
                        if (tsResp) { tsResp.textContent = 'Updated ' + t; tsResp.classList.add('updated'); }
                        if (passStatus) { passStatus.textContent = 'Updated'; passStatus.className = 'dashboard-pass-status success'; }
                        setTimeout(function () { if (passStatus) { passStatus.textContent = ''; passStatus.className = 'dashboard-pass-status'; } }, 3000);
                    })
                    .catch(function (err) {
                        if (passStatus) { passStatus.textContent = err.message || 'Failed'; passStatus.className = 'dashboard-pass-status error'; }
                        setTimeout(function () { if (passStatus) passStatus.className = 'dashboard-pass-status'; }, 4000);
                    })
                    .finally(function () { sendNowBtn.disabled = false; });
            });
        }
    </script>
</body>
</html>
